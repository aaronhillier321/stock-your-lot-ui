# Deploy to GCP Kubernetes (GKE) on push/merge to main
name: Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  # Set these in GitHub repo Settings → Secrets and variables → Actions
  # GCP_PROJECT_ID: your GCP project ID
  # GCP_SA_KEY: contents of your GCP service account JSON key (entire file)
  # GKE_CLUSTER: your GKE cluster name
  # GKE_REGION: region or zone (e.g. us-central1 or us-central1-a)
  # GKE_NAMESPACE: optional, defaults to 'default'
  # GKE_ZONE: optional, use for zonal clusters (e.g. us-central1-a); else GKE_REGION used with --region
  # ARTIFACT_REGISTRY_REPO: optional, Artifact Registry repo name (default: stock-your-lot)
  # For Artifact Registry use region only (e.g. us-central1), not zone
  IMAGE_NAME: stock-your-lot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GKE_REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        id: build-image
        run: |
          REGION="${{ secrets.GKE_REGION }}"
          PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
          REPO="${{ secrets.ARTIFACT_REGISTRY_REPO || 'stock-your-lot' }}"
          SHA="${GITHUB_SHA::7}"
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE_NAME}:${SHA}"
          IMAGE_LATEST="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE_NAME}:latest"
          docker build -t "$IMAGE" -t "$IMAGE_LATEST" .
          docker push "$IMAGE"
          docker push "$IMAGE_LATEST"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "image_latest=${IMAGE_LATEST}" >> $GITHUB_OUTPUT

      - name: Get GKE credentials
        run: |
          if [ -n "${{ secrets.GKE_ZONE }}" ]; then
            gcloud container clusters get-credentials "${{ secrets.GKE_CLUSTER }}" \
              --zone "${{ secrets.GKE_ZONE }}" \
              --project "${{ secrets.GCP_PROJECT_ID }}"
          else
            gcloud container clusters get-credentials "${{ secrets.GKE_CLUSTER }}" \
              --region "${{ secrets.GKE_REGION }}" \
              --project "${{ secrets.GCP_PROJECT_ID }}"
          fi

      - name: Deploy to GKE
        run: |
          IMAGE="${{ steps.build-image.outputs.image }}"
          NAMESPACE="${{ secrets.GKE_NAMESPACE || 'default' }}"
          # Substitute image in deployment manifest
          sed "s|IMAGE_PLACEHOLDER|${IMAGE}|g" k8s/deployment.yaml > k8s/deployment.resolved.yaml
          kubectl create namespace "$NAMESPACE" --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/deployment.resolved.yaml -n "$NAMESPACE"
          kubectl apply -f k8s/service.yaml -n "$NAMESPACE"
          kubectl rollout status deployment/stock-your-lot -n "$NAMESPACE" --timeout=120s
